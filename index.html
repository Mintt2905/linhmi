<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gửi Lời Chúc Tới 2 Cô Dâu!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .font-pacifico {
            font-family: 'Pacifico', cursive;
        }
        /* Chat-related styles removed as per request */
        .message-box {
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            margin-top: 16px;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #065f46; /* green-700 */
            color: #d1fae5; /* green-100 */
        }
        .message-box.error {
            background-color: #991b1b; /* red-800 */
            color: #fee2e2; /* red-100 */
        }
        .message-box.info {
            background-color: #1e3a8a; /* blue-800 */
            color: #dbeafe; /* blue-100 */
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <div class="bg-gray-900/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-10 relative">

            <!-- Language selection area -->
            <div class="absolute top-4 right-4 flex space-x-2">
                <button id="lang-vi" class="lang-btn px-3 py-1 text-sm border border-teal-600 rounded-md hover:bg-teal-700 transition">Tiếng Việt</button>
                <button id="lang-en" class="lang-btn px-3 py-1 text-sm border border-teal-600 rounded-md hover:bg-teal-700 transition">English</button>
            </div>

            <header class="text-center mb-8 pt-8">
                <h1 id="main-title" class="font-pacifico text-4xl md:text-5xl text-teal-300"></h1>
                <p id="main-subtitle" class="text-gray-400 mt-2 text-lg"></p>
            </header>

            <div class="space-y-6">
                <div>
                    <label id="name-label" for="guestName" class="block text-md font-semibold text-gray-300 mb-2"></label>
                    <input type="text" id="guestName" class="w-full px-4 py-3 bg-gray-800 border border-teal-700 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition text-white placeholder-gray-500">
                </div>
                <div>
                    <label id="wish-label" for="guestWish" class="block text-md font-semibold text-gray-300 mb-2"></label>
                    <textarea id="guestWish" rows="5" class="w-full px-4 py-3 bg-gray-800 border border-teal-700 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition text-white placeholder-gray-500"></textarea>
                </div>
                <button id="submitWish" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-transform transform hover:scale-105 shadow-lg"></button>

                <!-- Message box for alerts -->
                <div id="messageBox" class="message-box"></div>

                <!-- Export to Google Sheets section - REMOVED FROM UI FOR USERS -->
                <!--
                <div class="mt-8 pt-6 border-t-2 border-teal-900/50">
                    <h2 id="export-title" class="font-pacifico text-2xl text-center text-teal-300 mb-4"></h2>
                    <p id="export-description" class="text-gray-400 text-center mb-4"></p>
                    <button id="exportWishesBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="10" y2="9"></line></svg>
                        <span id="export-button-text"></span>
                    </button>
                </div>
                -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-wedding-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        let app, auth, db;
        let userId = null;
        let wishesCache = [];

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                listenForWishes();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            }
        });

        // --- DOM Elements ---
        const guestName = document.getElementById('guestName');
        const guestWish = document.getElementById('guestWish');
        const submitWishBtn = document.getElementById('submitWish');
        const langViBtn = document.getElementById('lang-vi');
        const langEnBtn = document.getElementById('lang-en');
        const messageBox = document.getElementById('messageBox');
        // const exportWishesBtn = document.getElementById('exportWishesBtn'); // Removed as per request

        // --- I18N & Language Logic ---
        let currentLanguage = 'vi';
        const translations = {
            en: {
                mainTitle: "Send Your Wishes",
                mainSubtitle: "To our two lovely brides!",
                nameLabel: "Your Name",
                namePlaceholder: "E.g., Jane Doe",
                wishLabel: "Your sweet wish",
                wishPlaceholder: "Wishing you a lifetime of happiness...",
                submitButton: "Send Wish",
                submitButtonSending: "Sending...",
                fillFieldsMessage: "Please fill in both your name and your wish!",
                wishSentMessage: "Thank you for sending your wish!",
                wishErrorMessage: "An error occurred while sending your wish. Please try again.",
                exportTitle: "Export Wishes", // Kept for potential console use
                exportDescription: "Download all collected wishes as a CSV file, which can be easily imported into Google Sheets.", // Kept for potential console use
                exportButtonText: "Download Wishes (CSV)", // Kept for potential console use
                noWishesToExport: "No wishes to export yet."
            },
            vi: {
                mainTitle: "Gửi Lời Chúc",
                mainSubtitle: "Tới hai cô dâu của chúng ta!",
                nameLabel: "Tên của bạn",
                namePlaceholder: "Ví dụ: An Nhiên",
                wishLabel: "Lời chúc ngọt ngào",
                wishPlaceholder: "Chúc hai bạn trăm năm hạnh phúc...",
                submitButton: "Gửi lời chúc",
                submitButtonSending: "Đang gửi...",
                fillFieldsMessage: "Vui lòng điền cả tên và lời chúc của bạn nhé!",
                wishSentMessage: "Cảm ơn bạn đã gửi lời chúc!",
                wishErrorMessage: "Đã có lỗi xảy ra khi gửi lời chúc. Vui lòng thử lại.",
                exportTitle: "Xuất Lời Chúc", // Kept for potential console use
                exportDescription: "Tải xuống tất cả lời chúc đã thu thập dưới dạng tệp CSV, có thể dễ dàng nhập vào Google Sheets.", // Kept for potential console use
                exportButtonText: "Tải xuống Lời Chúc (CSV)", // Kept for potential console use
                noWishesToExport: "Chưa có lời chúc nào để xuất."
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];

            document.documentElement.lang = lang;
            document.getElementById('main-title').textContent = t.mainTitle;
            document.getElementById('main-subtitle').textContent = t.mainSubtitle;
            document.getElementById('name-label').textContent = t.nameLabel;
            guestName.placeholder = t.namePlaceholder;
            document.getElementById('wish-label').textContent = t.wishLabel;
            guestWish.placeholder = t.wishPlaceholder;
            submitWishBtn.textContent = t.submitButton;
            // Removed direct DOM updates for export section elements
            // document.getElementById('export-title').textContent = t.exportTitle;
            // document.getElementById('export-description').textContent = t.exportDescription;
            // document.getElementById('export-button-text').textContent = t.exportButtonText;

            // Update active button style
            langViBtn.classList.toggle('active', lang === 'vi');
            langEnBtn.classList.toggle('active', lang === 'en');
        }

        langViBtn.addEventListener('click', () => setLanguage('vi'));
        langEnBtn.addEventListener('click', () => setLanguage('en'));

        // --- Message Display Function ---
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Reset classes and apply new type
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // --- Firestore Logic ---
        const wishesCollectionPath = `/artifacts/${appId}/public/data/wishes`;

        async function saveWish(name, wish) {
            if (!db) return;
            try {
                await addDoc(collection(db, wishesCollectionPath), { name, wish, createdAt: new Date() });
                guestName.value = '';
                guestWish.value = '';
                showMessage(translations[currentLanguage].wishSentMessage, 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(translations[currentLanguage].wishErrorMessage, 'error');
            }
        }

        function listenForWishes() {
            if (!db) return;
            const q = query(collection(db, wishesCollectionPath));
            onSnapshot(q, (snapshot) => {
                wishesCache = snapshot.docs.map(doc => ({
                    id: doc.id, // Include document ID if needed
                    ...doc.data()
                }));
                console.log("Wishes cache updated:", wishesCache);
            }, (error) => console.error("Error listening for wishes:", error));
        }

        // --- Export to CSV Function (Accessible via console for owner) ---
        // This function is made global for easy access from the browser console.
        window.exportWishesToCsv = function() {
            if (wishesCache.length === 0) {
                console.log(translations[currentLanguage].noWishesToExport);
                return;
            }

            // Define CSV headers
            const headers = ['Name', 'Wish', 'Timestamp'];

            // Map data to CSV rows
            const rows = wishesCache.map(wish => {
                const name = `"${wish.name.replace(/"/g, '""')}"`; // Handle quotes in name
                const wishText = `"${wish.wish.replace(/"/g, '""')}"`; // Handle quotes in wish
                const timestamp = wish.createdAt ? new Date(wish.createdAt.toDate()).toLocaleString() : ''; // Convert Firebase Timestamp to readable string
                return [name, wishText, timestamp].join(',');
            });

            // Combine headers and rows
            const csvContent = [headers.join(','), ...rows].join('\n');

            // Create a Blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'wedding_wishes.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log("Wishes exported to wedding_wishes.csv");
            } else {
                // Fallback for browsers that don't support download attribute
                console.warn("Your browser does not support downloading files directly. Please copy the content below:");
                console.log(csvContent);
            }
        };

        // --- Event Listeners ---
        submitWishBtn.addEventListener('click', async () => {
            const name = guestName.value.trim();
            const wish = guestWish.value.trim();

            if (!name || !wish) {
                showMessage(translations[currentLanguage].fillFieldsMessage, 'error');
                return;
            }

            submitWishBtn.disabled = true;
            submitWishBtn.textContent = translations[currentLanguage].submitButtonSending;

            await saveWish(name, wish);

            submitWishBtn.disabled = false;
            submitWishBtn.textContent = translations[currentLanguage].submitButton;
        });

        // exportWishesBtn.addEventListener('click', exportWishesToCsv); // Removed event listener for the button

        // Initialize with default language
        setLanguage('vi');

    </script>
</body>
</html>
